{% extends "base.html" %}
{% load static %}

{% block content %}
<div style="margin: 24px 32px 0 32px;">

    <!-- HEADER BAR -->
    <div style="
        background:#f5f7fb;
        border:1px solid #e2e6f0;
        border-bottom:none;
        padding:10px 20px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        font-size:16px;
        font-weight:600;
        color:#444;
    ">
        <span>Product Master</span>

        <form method="get" style="margin:0;">
            <input type="text"
                   name="q"
                   value="{{ search }}"
                   placeholder="Search Product"
                   style="
                     width:260px;
                     padding:4px 8px;
                     border:1px solid #d0d4e0;
                     border-radius:2px;
                     font-size:13px;
                   ">
        </form>
    </div>

    <!-- BODY CARD -->
    <div style="
        border:1px solid #e2e6f0;
        border-top:none;
        background:#ffffff;
        padding:16px 20px 20px 20px;
    ">

        <!-- FORM -->
        <form method="post" style="margin-bottom:18px;">
            {% csrf_token %}

            <div style="display:flex; gap:40px;">

                <!-- LEFT COLUMN -->
                <div style="flex:1;">
                    <div style="margin-bottom:10px;">
                        <label style="font-size:13px;">* Select Product</label><br>
                        <select name="base_product"
                                style="width:100%; padding:4px 6px; font-size:13px;
                                       border:1px solid #d0d4e0;">
                            <option value="">Select</option>
                            {% for p in products %}
                                <option value="{{ p.id }}">{{ p.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- NEW: Inventory Type -->
                    <div style="margin-bottom:10px;">
                        <label style="font-size:13px;">* Inventory Type</label><br>
                        <select id="inventory_type" name="inventory_type"
                                style="width:100%; padding:4px 6px; font-size:13px;
                                    border:1px solid #d0d4e0;">
                            {% for code, label in INVENTORY_TYPE_CHOICES %}
                                <option value="{{ code }}"
                                    {% if code == current_inventory_type %}selected{% endif %}>
                                    {{ label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div style="margin-bottom:10px;">
                        <label style="font-size:13px;">* Unit</label><br>
                        <select name="unit"
                                style="width:100%; padding:4px 6px; font-size:13px;
                                       border:1px solid #d0d4e0;">
                            <option value="">Select</option>
                            {% for u in units %}
                                <option value="{{ u.id }}">{{ u.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div style="margin-bottom:10px;">
                        <label style="font-size:13px;">* Pack Qty</label><br>
                        <input type="text" name="pack_qty"
                               style="width:100%; padding:4px 6px; font-size:13px;
                                      border:1px solid #d0d4e0;">
                    </div>

                    <div style="margin-bottom:10px;">
                        <label style="font-size:13px;">* Incentive</label><br>
                        <input type="text" name="incentive"
                               style="width:100%; padding:4px 6px; font-size:13px;
                                      border:1px solid #d0d4e0;">
                    </div>

                    <!-- SOLID row with ID -->
                    <div id="row_solid" style="margin-bottom:10px;">
                        <label style="font-size:13px;">* Solid</label><br>
                        <input type="number" step="0.01" inputmode="decimal"
                            name="solid"
                            style="width:100%; padding:4px 6px; font-size:13px;
                                    border:1px solid #d0d4e0;">
                    </div>
                </div>

                <!-- RIGHT COLUMN -->
                <div style="flex:1;">
                    <div style="margin-bottom:10px;">
                        <label style="font-size:13px;">* Product Name</label><br>
                        <input type="text" name="product_name_display"
                               placeholder="(auto – same as selected product)"
                               disabled
                               style="width:100%; padding:4px 6px; font-size:13px;
                                      border:1px solid #e0e0e0; background:#f8f8f8;">
                    </div>

                    <div style="margin-bottom:10px;">
                        <label style="font-size:13px;">* Selling Price</label><br>
                        <input type="number"
                            name="selling_price"
                            step="0.01"
                            inputmode="decimal"
                            style="width:100%; padding:4px 6px; font-size:13px;
                                    border:1px solid #d0d4e0;">
                    </div>

                    <!-- PACKED IN row with ID, now dropdown -->
                    <div id="row_packed_in" style="margin-bottom:10px;">
                        <label style="font-size:13px;">* Packed In</label><br>
                        <select name="packed_in"
                                style="width:100%; padding:4px 6px; font-size:13px;
                                       border:1px solid #d0d4e0;">
                            <option value="">Select</option>
                            {% for opt in packed_in_choices %}
                                <option value="{{ opt }}">{{ opt }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div style="margin-bottom:10px;">
                        <label style="font-size:13px;">* Min Stock Level</label><br>
                        <input type="number"
                            name="min_stock_level"
                            step="0.01"
                            inputmode="decimal"
                            style="width:100%; padding:4px 6px; font-size:13px;
                                    border:1px solid #d0d4e0;">
                    </div>

                    <div style="margin-bottom:10px;">
                        <label style="font-size:13px;">* Raw Material Cost</label><br>
                        <input type="number"
                            name="raw_material_cost"
                            step="0.01"
                            inputmode="decimal"
                            style="width:100%; padding:4px 6px; font-size:13px;
                                    border:1px solid #d0d4e0;">
                    </div>

                    <!-- DENSITY row with ID -->
                    <div id="row_density" style="margin-bottom:10px;">
                        <label style="font-size:13px;">* Density</label><br>
                        <input type="number" step="0.001" inputmode="decimal"
                            name="density"
                            style="width:100%; padding:4px 6px; font-size:13px;
                                    border:1px solid #d0d4e0;">
                    </div>
                </div>
            </div>

            <!-- BUTTON ROW -->
            <div style="margin-top:16px; text-align:center;">
                <button type="button"
                        onclick="window.location.href=window.location.href;"
                        style="min-width:80px; margin-right:6px;
                               background:#2f6fb6; color:#fff; border:none;
                               padding:6px 14px; font-size:13px;">
                    New
                </button>

                <button type="submit"
                        style="min-width:80px; margin-right:6px;
                               background:#5cb85c; color:#fff; border:none;
                               padding:6px 14px; font-size:13px;">
                    Save
                </button>

                <button type="button"
                        disabled
                        style="min-width:80px; margin-right:6px;
                               background:#a6c7a6; color:#fff; border:none;
                               padding:6px 14px; font-size:13px;">
                    Update
                </button>

                <button type="button"
                        disabled
                        style="min-width:80px; margin-right:6px;
                               background:#2f6fb6; color:#fff; border:none;
                               padding:6px 14px; font-size:13px;">
                    Export
                </button>

                <a href="{% url 'master_dashboard' %}"
                   style="min-width:80px; display:inline-block;
                          background:#d9534f; color:#fff; text-decoration:none;
                          padding:6px 14px; font-size:13px;">
                    Close
                </a>
            </div>
        </form>

        <!-- GRID -->
        <div style="margin-top:20px;">
            <table style="width:100%; border-collapse:collapse; font-size:13px;">
                <thead>
                    <tr>
                        <th style="background:#0c7db1;color:#fff;padding:6px 8px;text-align:left;">Product ID</th>
                        <th style="background:#0c7db1;color:#fff;padding:6px 8px;text-align:left;">Product Name</th>
                        <th style="background:#0c7db1;color:#fff;padding:6px 8px;text-align:right;">Price</th>
                        <th style="background:#0c7db1;color:#fff;padding:6px 8px;text-align:left;">Master Product Name</th>
                        <th style="background:#0c7db1;color:#fff;padding:6px 8px;text-align:left;">Unit</th>
                        <th style="background:#0c7db1;color:#fff;padding:6px 8px;text-align:center;">Delete</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in rows %}
                    <tr style="border-bottom:1px solid #eef1f6;">
                        <td style="padding:6px 8px;">{{ r.id }}</td>
                        <td style="padding:6px 8px;">{{ r.base_product.name }}</td>
                        <td style="padding:6px 8px; text-align:right;">
                            {{ r.selling_price|default_if_none:"" }}
                        </td>
                        <td style="padding:6px 8px;">
                            {{ r.base_product.name }}
                        </td>
                        <td style="padding:6px 8px;">
                            {% if r.unit %}
                                {{ r.unit.name }}
                            {% endif %}
                        </td>
                        <td style="padding:6px 8px; text-align:center;">
                            <form method="post"
                                  action="{% url 'product_master_detail_delete' r.id %}"
                                  style="display:inline;">
                                {% csrf_token %}
                                <button type="submit"
                                        style="background:none;border:none;cursor:pointer;padding:0;"
                                        onclick="return confirm('Delete this product master record?');"
                                        title="Delete">
                                    <img src="{% static 'img/bin.png' %}"
                                         alt="Delete"
                                         style="width:16px;height:16px;display:inline-block;vertical-align:middle;">
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6"
                            style="padding:10px; text-align:center; color:#888;">
                            No product master records yet.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
</div>

<!-- JS: show/hide fields based on inventory type -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const inventorySelect = document.getElementById('inventory_type');
    const densityRow = document.getElementById('row_density');
    const solidRow = document.getElementById('row_solid');
    const packedInRow = document.getElementById('row_packed_in');

    if (!inventorySelect) return;

    function updateFormFields() {
        const type = inventorySelect.value;

        if (type === 'RM') {
            // Raw Material → show density & solids, hide packed in
            if (densityRow) densityRow.style.display = 'block';
            if (solidRow) solidRow.style.display = 'block';
            if (packedInRow) packedInRow.style.display = 'none';
        } else {
            // Finished Goods / Packing Material → packed in only
            if (densityRow) densityRow.style.display = 'none';
            if (solidRow) solidRow.style.display = 'none';
            if (packedInRow) packedInRow.style.display = 'block';
        }
    }

    inventorySelect.addEventListener('change', updateFormFields);
    updateFormFields();
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const numericFields = [
        'selling_price',
        'min_stock_level',
        'raw_material_cost',
    ];

    numericFields.forEach(function (name) {
        const el = document.querySelector('input[name="' + name + '"]');
        if (!el) return;

        el.addEventListener('input', function () {
            if (this.value.indexOf(',') !== -1) {
                this.value = this.value.replace(/,/g, '.');
            }
        });
    });
});
</script>
{% endblock %}