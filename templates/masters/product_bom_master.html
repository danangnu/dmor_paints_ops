{% extends "base.html" %}
{% load static %}

{% block content %}
<div style="margin: 24px 32px 0 32px;">

    <!-- HEADER STRIP -->
    <div style="
        background: #f5f7fb;
        border: 1px solid #e2e6f0;
        border-bottom: none;
        padding: 10px 20px;
        font-size: 16px;
        font-weight: 600;
        color: #444;
    ">
        Product BOM Master
    </div>

    <!-- BODY CARD -->
    <div style="
        border: 1px solid #e2e6f0;
        border-top: none;
        background: #ffffff;
        padding: 20px 24px 24px 24px;
    ">

        <!-- MESSAGES -->
        {% if messages %}
            <div style="margin-bottom: 12px;">
                {% for message in messages %}
                    <div style="
                        padding: 6px 10px;
                        margin-bottom: 4px;
                        border-radius: 3px;
                        font-size: 13px;
                        {% if message.tags == 'error' %}
                            background:#fdecea; color:#b71c1c; border:1px solid #f5c6cb;
                        {% else %}
                            background:#e8f5e9; color:#256029; border:1px solid #c8e6c9;
                        {% endif %}
                    ">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <form method="post">
            {% csrf_token %}

            <!-- TOP FIELDS -->
            <table style="width:100%; border-collapse:collapse; font-size:13px;">
                <tr>
                    <!-- Category -->
                    <td style="width:25%; padding:4px 8px;">
                        <span style="color:red;">*</span>
                        Category
                    </td>
                    <td style="width:25%; padding:4px 8px;">
                        <select name="category_id"
                                style="height:30px;font-size:13px;"
                                onchange="
                                    if (this.value) {
                                        window.location='?category_id='+encodeURIComponent(this.value);
                                    } else {
                                        window.location='{{ request.path }}';
                                    }
                                ">
                            <option value="">Select</option>
                            {% for p in products %}
                                <option value="{{ p.id }}"
                                    {% if form_category_id|stringformat:'s' == p.id|stringformat:'s' %}
                                        selected
                                    {% endif %}>
                                    {{ p.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>

                    <!-- Density -->
                    <td style="width:15%; padding:4px 8px;">
                        <span style="color:red;">*</span>
                        Density
                    </td>
                    <td style="width:35%; padding:4px 8px;">
                        <input type="text" name="density"
                               value="{{ form_density }}"
                               placeholder="Density"
                               style="width:100%; padding:4px 6px; border:1px solid #ccc; font-size:13px;">
                    </td>
                </tr>

                <tr>
                    <!-- Per % -->
                    <td style="padding:4px 8px;">
                        <span style="color:red;">*</span>
                        Per %
                    </td>
                    <td style="padding:4px 8px;">
                        <input type="text" name="per_percent"
                               value="{{ form_per_percent }}"
                               placeholder="Per %"
                               style="width:100%; padding:4px 6px; border:1px solid #ccc; font-size:13px;">
                    </td>

                    <!-- Hours -->
                    <td style="padding:4px 8px;">
                        <span style="color:red;">*</span>
                        Hours
                    </td>
                    <td style="padding:4px 8px;">
                        <input type="text" name="hours"
                               value="{{ form_hours }}"
                               placeholder="Hours"
                               style="width:100%; padding:4px 6px; border:1px solid #ccc; font-size:13px;">
                    </td>
                </tr>
            </table>

            <!-- BUTTONS -->
            <div style="margin-top:24px; text-align:center;">
                <button type="submit"
                        style="min-width:90px; margin-right:8px; padding:6px 18px; border:none;
                               background:#4caf50; color:#fff; font-size:13px; font-weight:600;">
                    Save
                </button>
                <a href="{% url 'master_dashboard' %}"
                   style="display:inline-block; min-width:90px; padding:6px 18px;
                          background:#d9534f; color:#fff; text-decoration:none;
                          font-size:13px; font-weight:600;">
                    Close
                </a>
            </div>

            <!-- BOM DETAIL GRID (like old system) -->
            {% if show_bom_table %}
            <div style="margin-top:24px;">
                <table style="width:100%;border-collapse:collapse;font-size:13px;">
                    <thead>
                    <tr>
                        <th style="background:#0c7db1;color:#fff;padding:6px 8px;width:80px;">Product Id</th>
                        <th style="background:#0c7db1;color:#fff;padding:6px 8px;">Product Name</th>
                        <th style="background:#0c7db1;color:#fff;padding:6px 8px;width:120px;">Percent %</th>
                        <th style="background:#0c7db1;color:#fff;padding:6px 8px;width:120px;">Sequence</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for p in products %}
                        <tr style="border-bottom:1px solid #eef1f6;">
                            <td style="padding:6px 8px;">{{ p.id }}</td>
                            <td style="padding:6px 8px;">{{ p.name }}</td>

                            <!-- Percent % input for this product in the BOM -->
                            <td style="padding:4px 8px;">
                                <input type="number"
                                    name="percent_{{ p.id }}"
                                    step="0.01"
                                    inputmode="decimal"
                                    value="0"
                                    style="width:100%;height:24px;font-size:12px;">
                            </td>

                            <!-- Sequence input -->
                            <td style="padding:4px 8px;">
                                <input type="number"
                                    name="seq_{{ p.id }}"
                                    step="1"
                                    value="0"
                                    style="width:100%;height:24px;font-size:12px;">
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="4"
                                style="padding:8px;text-align:center;color:#888;">
                                No products available.
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </form>

        <!-- LIST TABLE (summary of saved BOMs) -->
        <div style="margin-top:24px;">
            <table style="width:100%; border-collapse:collapse; font-size:13px;">
                <thead>
                    <tr>
                        <th style="background:#0c7db1; color:#fff; padding:6px 8px; text-align:left;">Category</th>
                        <th style="background:#0c7db1; color:#fff; padding:6px 8px; text-align:right;">Per %</th>
                        <th style="background:#0c7db1; color:#fff; padding:6px 8px; text-align:right;">Density</th>
                        <th style="background:#0c7db1; color:#fff; padding:6px 8px; text-align:right;">Hours</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in bom_list %}
                        <tr style="border-bottom:1px solid #eef1f6;">
                            <td style="padding:6px 8px;">{{ r.category.name }}</td>
                            <td style="padding:6px 8px; text-align:right;">{{ r.per_percent }}</td>
                            <td style="padding:6px 8px; text-align:right;">{{ r.density }}</td>
                            <td style="padding:6px 8px; text-align:right;">{{ r.hours }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="4" style="padding:10px; text-align:center; color:#888;">
                                No BOM records found.
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
</div>
{% endblock %}